# ====================================================================
# QD - Purge compl√®te du cache d'identit√© FSLogix (RDS safe - auto-d√©pannage)
# ====================================================================

Add-Type -AssemblyName System.Windows.Forms

# --- Avertissement utilisateur ---
$dialogResult = [System.Windows.Forms.MessageBox]::Show(
    "ATTENTION : Tous les programmes Office (Outlook, Teams, OneDrive, Word, Excel, etc.) vont √™tre FERM√âS.
Assurez-vous d'avoir SAUVEGARD√â votre travail avant de continuer.",
    "Avertissement - Purge FSLogix",
    [System.Windows.Forms.MessageBoxButtons]::OKCancel,
    [System.Windows.Forms.MessageBoxIcon]::Warning
)

if ($dialogResult -ne [System.Windows.Forms.DialogResult]::OK) {
    Write-Host "Op√©ration annul√©e par l'utilisateur."
    exit
}

Write-Host "üîé Fermeture des applications Microsoft 365..." -ForegroundColor Cyan

# Liste des processus Office / M365 susceptibles de verrouiller les caches
$ProcTargets = @(
    "OUTLOOK","TEAMS","ONEDRIVE","WINWORD","EXCEL","POWERPNT",
    "MSACCESS","VISIO","LYNC","ONENOTE",
    "OfficeClickToRun","C2RClient","MSOSYNC","MSOIDSVC",
    "msedgewebview2","SearchProtocolHost"
)

$CurrentSessionID = (Get-Process -Id $PID).SessionId

foreach ($p in $ProcTargets) {
    $Procs = Get-Process -Name $p -ErrorAction SilentlyContinue | Where-Object { $_.SessionId -eq $CurrentSessionID }
    foreach ($proc in $Procs) {
        try {
            Stop-Process -Id $proc.Id -Force -ErrorAction Stop
            Write-Host "‚úÖ Processus $($proc.ProcessName) (PID $($proc.Id)) ferm√©." -ForegroundColor Green
        } catch {
            Write-Warning "Impossible de fermer $($proc.ProcessName) (PID $($proc.Id)) : $($_.Exception.Message)"
        }
    }
}

Start-Sleep -Seconds 2
Write-Host "üßπ Fermeture des processus termin√©e. Passage √† la purge des caches..." -ForegroundColor Cyan

# --- Cibles √† nettoyer (niveau 2 - complet et s√ªr pour FSLogix) ---
$Targets = @(
    "$env:LOCALAPPDATA\Microsoft\OneAuth",
    "$env:LOCALAPPDATA\Microsoft\IdentityCache",
    "$env:LOCALAPPDATA\Microsoft\TokenBroker",
    "$env:LOCALAPPDATA\Microsoft\Office\16.0\WebServiceCache",
    "$env:LOCALAPPDATA\Microsoft\Office\16.0\Wef",
    "$env:LOCALAPPDATA\Microsoft\Office\16.0\Licensing",
    "$env:LOCALAPPDATA\Microsoft\Office\16.0\Identity"
)

foreach ($path in $Targets) {
    if (Test-Path $path) {
        Write-Host "üßΩ Nettoyage de $path..." -ForegroundColor Yellow
        try {
            Remove-Item -Path $path -Recurse -Force -ErrorAction Stop
        } catch {
            Write-Warning "Impossible de supprimer certains fichiers dans $path. Tentative de renommage..."
            Get-ChildItem -Path $path -Recurse -ErrorAction SilentlyContinue | ForEach-Object {
                try {
                    Rename-Item -Path $_.FullName -NewName ($_.Name + ".bak") -ErrorAction Stop
                } catch {
                    Write-Warning "Fichier verrouill√© non renomm√© : $($_.FullName)"
                }
            }
            try {
                Remove-Item -Path $path -Recurse -Force -ErrorAction SilentlyContinue
            } catch {
                Write-Warning "‚ö†Ô∏è Dossier encore partiellement verrouill√© : $path"
            }
        }
    } else {
        Write-Host "‚ÑπÔ∏è Dossier introuvable : $path" -ForegroundColor DarkGray
    }
}

Write-Host "‚úÖ Purge termin√©e. D√©connectez-vous et reconnectez-vous pour r√©g√©n√©rer les jetons d'identit√© (MFA)." -ForegroundColor Green
