# ====================================================================
# QD - DÃ©tection rÃ©cursive de chemins > 260 caractÃ¨res
#      (option dossiers + affichage complet + plus long fichier)
# ====================================================================

$TargetFolder   = 'E:\DATA\Techniques\6000-6099\6011 MFILES\6011 - 41-appel offre\6011-Construction Bois\02_Version_02_Janvier_2023\Retour des offres'
$IncludeFolders = $true     # ğŸ” Inclure les dossiers dans le contrÃ´le
$ShowAll        = $true     # ğŸ‘€ Afficher chaque Ã©lÃ©ment analysÃ©
$MaxLength      = 260       # ğŸ§± Limite de longueur de chemin

Write-Host "`nAnalyse du dossier : $TargetFolder`n" -ForegroundColor Cyan

try {
    $Items = Get-ChildItem -Path $TargetFolder -Recurse -Force -ErrorAction Stop
}
catch {
    Write-Host "âŒ Erreur lors de la lecture du dossier : $($_.Exception.Message)" -ForegroundColor Red
    return
}

$CountTooLong = 0
$CountTotal   = 0
$LongestItem  = $null
$LongestLen   = 0

foreach ($Item in $Items) {

    if (-not $IncludeFolders -and $Item.PSIsContainer) { continue }

    $CountTotal++
    $FullPath = $Item.FullName
    $Len = $FullPath.Length

    # Affichage de tout ce qui est contrÃ´lÃ© (mode debug)
    if ($ShowAll) {
        if ($Item.PSIsContainer) {
            Write-Host "[CHECK DOSSIER]" -ForegroundColor DarkGray -NoNewline
        } else {
            Write-Host "[CHECK FICHIER]" -ForegroundColor Gray -NoNewline
        }
        Write-Host " $FullPath"
    }

    # VÃ©rifie la longueur
    if ($Len -gt $MaxLength) {
        $CountTooLong++
        if ($Item.PSIsContainer) {
            Write-Host "[DOSSIER LONG] ($Len caractÃ¨res) " -ForegroundColor Yellow -NoNewline
        } else {
            Write-Host "[FICHIER LONG] ($Len caractÃ¨res) " -ForegroundColor Red -NoNewline
        }
        Write-Host "$FullPath"
    }

    # Suivi du plus long chemin rencontrÃ©
    if ($Len -gt $LongestLen) {
        $LongestLen  = $Len
        $LongestItem = $Item
    }
}

# RÃ©sumÃ© final
Write-Host "`nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
Write-Host "ğŸ“Š Total contrÃ´lÃ© : $CountTotal Ã©lÃ©ment(s)" -ForegroundColor Cyan
if ($CountTooLong -eq 0) {
    Write-Host "âœ… Aucun chemin > $MaxLength caractÃ¨res dÃ©tectÃ©." -ForegroundColor Green
} else {
    Write-Host "âš ï¸  $CountTooLong Ã©lÃ©ment(s) dÃ©passent $MaxLength caractÃ¨res." -ForegroundColor Yellow
}
Write-Host "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# Affichage du plus long Ã©lÃ©ment dÃ©tectÃ©
if ($null -ne $LongestItem) {
    $type = if ($LongestItem.PSIsContainer) { "Dossier" } else { "Fichier" }
    Write-Host "`nğŸ Plus long Ã©lÃ©ment dÃ©tectÃ© :" -ForegroundColor Cyan
    Write-Host "   Type       : $type"
    Write-Host "   Longueur   : $LongestLen caractÃ¨res"
    Write-Host "   Chemin     : $($LongestItem.FullName)"
}
Write-Host ""
